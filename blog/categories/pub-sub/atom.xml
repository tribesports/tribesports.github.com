<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Pub/Sub | Tribesports Tech Blog]]></title>
  <link href="http://techblog.tribesports.com/blog/categories/pub-sub/atom.xml" rel="self"/>
  <link href="http://techblog.tribesports.com/"/>
  <updated>2012-10-08T12:57:58+01:00</updated>
  <id>http://techblog.tribesports.com/</id>
  <author>
    <name><![CDATA[Tribesports Tech Team]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Pub/Sub system events for post-action tasks]]></title>
    <link href="http://techblog.tribesports.com/blog/2012/08/21/pub-sub-system-events-for-post-action-tasks"/>
    <updated>2012-08-21T20:33:00+01:00</updated>
    <id>http://techblog.tribesports.com/blog/2012/08/21/pub-sub-system-events-for-post-action-tasks</id>
    <content type="html"><![CDATA[<h2>TL;DR</h2>

<p>Rails controllers are often a dumping ground for unrelated tasks.
We cleaned ours up using a pub/sub system of announced events and
task-specific listeners. This made our app easier to modify, easier to
test, and easier to read. Probably.</p>

<h2>Introduction</h2>

<p>In many Rails applications, controllers end up cluttered with a wide
array of post-action tasks: sending emails, posting to Facebook, custom
analytics/logging and more.</p>

<p>These cross-cutting concerns (and the logic associated with them) can
end up dominating controller actions, to the point where the controller
can no longer be easily tested, and the main purpose of the action is
hard to discern. The following might be an example, although we had much
more complex actions:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>app/controllers/comments_controller.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">class</span> <span class="nc">CommentsController</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="no">ApplicationController</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  def create&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">comment_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:comment</span><span class="o">].</span><span class="n">merge</span><span class="p">(</span><span class="ss">:creator</span> <span class="o">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">current_user</span><span class="p">)</span>
</span><span class='line'><span class="vi">@comment</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">comment_params</span><span class="p">)</span>
</span><span class='line'><span class="k">if</span> <span class="vi">@comment</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>  <span class="k">unless</span> <span class="n">current_user</span> <span class="o">==</span> <span class="vi">@comment</span><span class="o">.</span><span class="n">commentable</span><span class="o">.</span><span class="n">creator</span>
</span><span class='line'>    <span class="no">UserMailer</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="vi">@comment</span><span class="o">.</span><span class="n">commentable</span><span class="o">.</span><span class="n">creator</span><span class="p">,</span> <span class="vi">@comment</span><span class="p">)</span><span class="o">.</span><span class="n">deliver</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">twitters?</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">current_user</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="s2">&quot;twitter_post_comment&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="no">TwitterPoster</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="vi">@comment</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">current_user</span><span class="o">.</span><span class="n">reward_for</span><span class="p">(</span><span class="s1">&#39;create_comment&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">respond_with</span><span class="p">(</span><span class="vi">@comment</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/code&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>The majority of the action is concerned with doing things only
indirectly related to the actual creation of the comment. As a result
there are multiple code paths caused by the conditional logic that are
laborious to exhaustively test (and slow, because controller tests are
slow).</p>

<p>Some of the options for reducing this complexity are to move these
associated tasks into:</p>

<ol>
<li>ActiveModel lifecycle callbacks</li>
<li>ActiveModel observers</li>
<li>Controller filters</li>
<li>Service objects</li>
<li>Pub/sub system events</li>
</ol>


<p>Anyone who has made extensive use of lifecycle callbacks for this sort
of thing will be familiar with the problems that triggering behaviour
with implicit events can cause (particularly when testing or debugging)
- we're looking for an explicit mechanism where it will still be obvious
in the controller that our intention is to trigger associated actions.
And just as we don't want to have our controllers responsible for all of
these secondary concerns, we don't want to make our model responsible
for them either.</p>

<p>We avoid ActiveModel::Observers for much the same reasons, and while
before/after filters in Rails' controllers are marginally more explicit
(being at least localised to the controller doing the action), we've
found that when they start stacking up they still tend to cause
surprising and hard-to-debug problems, not least because it can be
difficult to see which ones will apply to a given action. They're also
fiddly to disable when trying to test a controller action's logic in
isolation from what goes on around it.</p>

<p>Let's take a look at the remaining options.</p>

<h2>Service objects</h2>

<p>We could choose to create a service object that is responsible for
handling these post-commenting tasks. For instance, we might place our
comment creation logic in its own class as follows:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h1&gt;app/</span><span class="n">controllers</span><span class="o">/</span><span class="n">comments_controller</span><span class="o">.</span><span class="n">rb</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;class CommentsController &amp;lt; ApplicationController&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">def</span> <span class="nf">create</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;@comment = CommentCreationService.new.create(params[:comment])</span>
</span><span class='line'><span class="sr">respond_with(@comment)</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;h1&gt;app/se</span><span class="n">rvices</span><span class="o">/</span><span class="n">comment_creation_service</span><span class="o">.</span><span class="n">rb</span><span class="o">&lt;</span><span class="sr">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;class CommentCreationService&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;comment = Comment.new(params)</span>
</span><span class='line'><span class="sr">if comment.save</span>
</span><span class='line'><span class="sr">  mail_user(comment)</span>
</span><span class='line'><span class="sr">  post_to_twitter(comment)</span>
</span><span class='line'><span class="sr">  reward_user_for(comment)</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'><span class="sr">comment</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">def</span> <span class="nf">post_to_twitter</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;# ...</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="c1"># ...&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This cleans up the controller, and the service object itself is more
amenable to testing, but we're still left with an object with too
many collaborators, addressing too many unrelated concerns. Service
objects can certainly be useful if the actual creation of a comment
involves more complex manipulation than a simple <code>#create</code> call, but
they probably shouldn't be used as a dumping-ground for ancillary tasks,
any more than the controller should.</p>

<h2>Pub/Sub</h2>

<p>Here, the idea is to decouple our post-action tasks from the creation
of the comment. Rather than have any single entity be responsible for
all of the tasks that creating a comment might trigger, we create the
comment and announce this event via a message broker (we've called it an
"announcer"). Meanwhile, specialised listeners register their interest
in certain types of events with the announcer, and respond to those
events appropriately.</p>

<p>First, let's take a look at the announcer:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>lib/announcer.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">class</span> <span class="nc">Announcer</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  attr_reader :listeners&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">def</span> <span class="nf">listeners</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;@listeners ||= []</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">def</span> <span class="nf">add_listener</span><span class="p">(</span><span class="n">listener</span><span class="p">)</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;self.listeners &amp;lt;&amp;lt; listener</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">def</span> <span class="nf">announce</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;listeners.each do |listener|</span>
</span><span class='line'><span class="sr">  listener.send(message, *args) if listener.respond_to?(message)</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>spec/lib/announcer_spec.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../lib/announcer&#39;</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;describe Announcer do</span>
</span><span class='line'><span class="sr">  let(:announcer) { Announcer.new }&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="n">describe</span> <span class="s2">&quot;#add_listener&quot;</span> <span class="k">do</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;it &quot;adds a listener to the Announcer&#39;s listeners&quot; do</span>
</span><span class='line'><span class="sr">  listener = mock(&quot;Listener&quot;)</span>
</span><span class='line'><span class="sr">  announcer.add_listener(listener)</span>
</span><span class='line'><span class="sr">  announcer.listeners.should include listener</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="n">describe</span> <span class="s2">&quot;#announce&quot;</span> <span class="k">do</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;let(:listener) { stub(&quot;Listener&quot;)                 } </span>
</span><span class='line'><span class="sr">before         { announcer.add_listener(listener) } </span>
</span><span class='line'>
</span><span class='line'><span class="sr">it &quot;notifies listeners that respond to the given message&quot; do</span>
</span><span class='line'><span class="sr">  listener.stubs(:hello =&amp;gt; true)</span>
</span><span class='line'><span class="sr">  announcer.announce(:hello, &quot;some&quot;, &quot;args&quot;)</span>
</span><span class='line'><span class="sr">  listener.should have_received(:hello).with(&quot;some&quot;, &quot;args&quot;)</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'>
</span><span class='line'><span class="sr">it &quot;does not notify listeners that don&#39;t respond to the given message&quot; do</span>
</span><span class='line'><span class="sr">  announcer.announce(:hello, &quot;some&quot;, &quot;args&quot;)</span>
</span><span class='line'><span class="sr">  listener.should_not have_received(:hello)</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This allows listeners to be registered, and sends any announcements
it receives to interested listeners, where "interested" is defined as
"responds to the announced message". If an event is announced that
no-one is interested in, it will be silently dropped.</p>

<p>Now let's take a look at an example listener:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>app/listeners/mail_listener.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">class</span> <span class="nc">MailListener</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  def initialize(announcer, user_mail_job_klass = MailJob)&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="vi">@user_mail_job_klass</span> <span class="o">=</span> <span class="n">user_mail_job_klass</span>
</span><span class='line'><span class="n">announcer</span><span class="o">.</span><span class="n">add_listener</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/code&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  def create_comment(comment)&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">commentable</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">commentable</span>
</span><span class='line'><span class="k">unless</span> <span class="n">comment</span><span class="o">.</span><span class="n">creator</span> <span class="o">==</span> <span class="n">commentable</span><span class="o">.</span><span class="n">creator</span>
</span><span class='line'>  <span class="n">mail</span><span class="p">(</span><span class="ss">:comment</span><span class="p">,</span> <span class="n">commentable</span><span class="o">.</span><span class="n">creator</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/code&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  private&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">def</span> <span class="nf">mail</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;@user_mail_job_klass.new(*args)</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>spec/listeners/mail_listener_spec.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../app/listeners/mail_listener&#39;</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;describe MailListener do</span>
</span><span class='line'><span class="sr">  let(:announcer) { stub_everything(&quot;Announcer&quot;)                   }</span>
</span><span class='line'><span class="sr">  let(:job_klass) { stub_everything(&quot;Class:MailJob&quot;, :new =&gt; true) }</span>
</span><span class='line'><span class="sr">  let(:listener)  { MailListener.new(announcer, job_klass)         }&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="n">describe</span> <span class="s2">&quot;#create_comment&quot;</span> <span class="k">do</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;let(:user)        { stub(&quot;User&quot;)                          } </span>
</span><span class='line'><span class="sr">let(:commenter)   { stub(&quot;User:commenter&quot;)                } </span>
</span><span class='line'><span class="sr">let(:commentable) { stub(&quot;Commentable&quot;, :creator =&amp;gt; user) } </span>
</span><span class='line'><span class="sr">let(:comment)     { stub(&quot;Comment&quot;,</span>
</span><span class='line'><span class="sr">                         :creator =&amp;gt; commenter,</span>
</span><span class='line'><span class="sr">                         :commentable =&amp;gt; commentable) } </span>
</span><span class='line'>
</span><span class='line'><span class="sr">it &quot;sends a comment email to the commentable&#39;s creator&quot; do</span>
</span><span class='line'><span class="sr">  listener.create_comment(comment)</span>
</span><span class='line'><span class="sr">  job_klass.should have_received(:new).with(:comment, user, comment)</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'>
</span><span class='line'><span class="sr">it &quot;does nothing if the commenter created the commentable&quot; do</span>
</span><span class='line'><span class="sr">  commentable.stubs(:creator =&amp;gt; commenter)</span>
</span><span class='line'><span class="sr">  listener.create_comment(comment)     </span>
</span><span class='line'><span class="sr">  job_klass.should_not have_received(:new)</span>
</span><span class='line'><span class="sr">end</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>We initialize the listener with an announcer, and the listener registers
itself. Our <code>MailListener</code> class is interested in handling the
<code>:create_comment</code> event, so we define a <code>#create_comment</code> method with
the appropriate signature. Then we do whatever we want: in this case,
emailing the owner of the entity being commented on to let him know that
someone has posted a new comment. We also handle the case where the
owner has commented on his own item, and we write a test case.</p>

<p>We inject the mail job class in the listener's constructor rather than
create a hard dependency - as seen in the associated tests, this allows
us to pass in a test double on which we can place message expectations.
We supply a default argument in the <code>#initialize</code> method, however, so we
don't always have to pass in the <code>MailJob</code> class in normal use.</p>

<h2>Integration</h2>

<p>Now we've got an announcer that will dispatch messages to interested
parties, and a fully-tested listener that responds to a particular
event. We just need to hook everything together, and announce our event
in the controller.</p>

<p>For controllers to announce events, we need to put together an
<code>Announcer</code> instance for them to use. In our <code>ApplicationController</code>, we
add the following:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>app/controllers/application_controller.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">announcer</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;@announcer ||= Announcer.new.tap do |a|</span>
</span><span class='line'><span class="sr">                 MailListener.new(a)</span>
</span><span class='line'><span class="sr">               end</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">def</span> <span class="nf">announce</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;announcer.announce(*args)</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>We've got the infrastructure to announce events - now our original
controller action becomes the following (let's assume we've written
similar listeners for the other post-action tasks):</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>app/controllers/comments_controller.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">class</span> <span class="nc">CommentsController</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="no">ApplicationController</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  def create&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">comment_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:comment</span><span class="o">].</span><span class="n">merge</span><span class="p">(</span><span class="ss">:creator</span> <span class="o">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">current_user</span><span class="p">)</span>
</span><span class='line'><span class="vi">@comment</span> <span class="o">=</span> <span class="no">Comment</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">comment_params</span><span class="p">)</span>
</span><span class='line'><span class="n">announce</span><span class="p">(</span><span class="ss">:create_comment</span><span class="p">,</span> <span class="vi">@comment</span><span class="p">)</span> <span class="k">if</span> <span class="vi">@comment</span><span class="o">.</span><span class="n">persisted?</span>
</span><span class='line'><span class="n">respond_with</span><span class="p">(</span><span class="vi">@comment</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/code&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>spec/controllers/comments_controller_spec.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;describe CommentsController do</span>
</span><span class='line'><span class="sr">  before do&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="vi">@user</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
</span><span class='line'><span class="n">sign_in</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/code&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">end</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  describe &quot;POST &#39;create&#39;&quot; do&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">let</span><span class="p">(</span><span class="ss">:comment</span><span class="p">)</span> <span class="p">{</span> <span class="n">mock_model</span><span class="p">(</span><span class="no">Comment</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="n">let</span><span class="p">(</span><span class="ss">:comment_params</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="p">{</span> <span class="s1">&#39;commentable_type&#39;</span> <span class="o">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="s1">&#39;Activity&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;commentable_id&#39;</span> <span class="o">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">5</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;comment&#39;</span> <span class="o">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="s1">&#39;hello&#39;</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">before</span> <span class="p">{</span> <span class="no">Comment</span><span class="o">.</span><span class="n">stubs</span><span class="p">(</span><span class="ss">:create</span> <span class="o">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">comment</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">it</span> <span class="s2">&quot;creates a comment and announces a :create_comment event&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">comment</span><span class="o">.</span><span class="n">stubs</span><span class="p">(</span><span class="ss">:persisted?</span> <span class="o">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">post</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span> <span class="o">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">comment_params</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Comment</span><span class="o">.</span><span class="n">should</span> <span class="n">have_received</span><span class="p">(</span><span class="ss">:create</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="n">comment_params</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:creator</span> <span class="o">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="vi">@user</span><span class="p">))</span>
</span><span class='line'>  <span class="n">announcer</span><span class="o">.</span><span class="n">should</span> <span class="n">have_announced</span><span class="p">(</span><span class="ss">:create_comment</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">it</span> <span class="s2">&quot;renders the &#39;new&#39; template and announces nothing if the comment was not saved&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">comment</span><span class="o">.</span><span class="n">stubs</span><span class="p">(</span><span class="ss">:persisted?</span> <span class="o">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kp">false</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">post</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;comment&#39;</span> <span class="o">=&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">comment_params</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">announcer</span><span class="o">.</span><span class="n">should_not</span> <span class="n">have_announced</span><span class="p">(</span><span class="ss">:create_comment</span><span class="p">)</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;new&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/code&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Our controller action is now much cleaner. It assembles user input,
uses it to create the comment, then announces the relevant event and
hands over to Rails' responder to handle rendering or redirecting as
appropriate. And that's it. It doesn't need to know about emails, or
posting to Twitter, or site gamification rewards, or anything other than
creating a comment.</p>

<p>Our test is also simpler, and fully covers the action's logic. We're
using a stub announcer and a custom RSpec matcher to allow us to test
whether events have been announced, but we won't go in to the details
of that in this post. Each test contains multiple assertions, which
isn't great, but controller tests run slowly enough that it can be worth
making an exception to this rule of thumb.</p>

<h2>Integration Tests</h2>

<p>Our post-action tasks are now decoupled from our controller, and our
controller tests examine only the controller's behaviour. So while we've
gained coverage in some areas (we've now got thorough unit tests on
our listeners, for example), we've lost some elsewhere. Our original
controller tests, despite being gross, slow and unwieldy (not to mention
incomplete) did at least exercise quite a lot of our application stack.</p>

<p>What to do about this? Well, write some more integration tests, as
opposed to integration tests masquerading as unit tests. In our case
we've expanded our cucumber suite, making sure that at least one
scenario exercises each of our listeners' core functionality. This way
we can be confident that we've hooked things up properly. For critical
functionality, we further verify the expected outcomes. The level of
coverage we're applying depends on how critical the functionality is.
Things that drive user interaction are of paramount importance, like
emails and activity recording. Other things (like custom analytics)
might not be so important.</p>

<h2>Conclusions and caveats</h2>

<p>Okay, so we've done all this work. So what? What's better about our
system now? We feel the pros and cons break down as follows.</p>

<p><strong>Advantages</strong>:</p>

<ol>
<li>Controller actions aren't cluttered up with tangential tasks</li>
<li>Logic related to mailing, twitter posting etc. is kept in one place</li>
<li>Said logic can be tested in isolation from the controllers</li>
<li>Controller tests are simpler because you're dealing with fewer immediate
collaborators</li>
<li>Adding a new type of post-action task (e.g. analytics handling) only
requires a new listener - we don't need to make changes in multiple
controller actions</li>
<li>It's now easier to make responses to system events asynchronous,
speeding up our page render times.</li>
</ol>


<p><strong>Disadvantages</strong>:</p>

<ol>
<li>It's no longer so easy to see at a glance all of the things that happen in
response to a given controller action</li>
<li>Because the listeners are more loosely coupled, and tested in
isolation from the controllers, integration tests become more important.</li>
</ol>


<p>The disadvantages are not to be dismissed. Controller tests are simpler,
but they're also exercising fewer of our app's components (since we're
providing a stub announcer that does no forwarding), so coverage is
decreased. Listener logic may be thoroughly tested, but in isolation: we
need to make sure that we're putting these loosely-coupled components
together properly in our full app, and that the listeners interact
properly with real collaborators, as opposed to our test doubles. This
places a greater responsibility on our integration tests.</p>

<p>The advantages, however, are really significant. A change to, for
example, our user activity recording now no longer requires changes in
tens of controller actions; those changes are localised to one place,
and we no longer need to fret about finding every instance of activity
recording in our app. Lots of logic that was previously untestable is
now covered in listener tests, increasing our confidence in the correct
behaviour of our app. And these tests are blazing fast, because they
don't depend on Rails.</p>

<p>Looking further forward, we're likely to want to move these post-action
tasks to an asynchronous system, to get all but the most critical
actions out of our render path. Having a single point of entry for
system events (the announcer) makes it far easier for us to achieve
this.</p>

<h2>Should you do this in your app?</h2>

<p>I don't know. Maybe?</p>

<p>This was a response to our controllers having built up a thick crust of
cross-cutting concerns during the lifetime of our app. At the moment
we've got 9 listeners handling around 150 different post-action tasks,
and there's more work to be done. For us, the benefits of moving to this
system have been pretty clear already. For a smaller app, or one with a
shorter projected lifespan, this approach may well be overkill.</p>

<p>It should also be pointed out that we've only been living with this
system for a short while - it remains to be seen how it pans out in the
long run. So far, though, so good.</p>

<p>p.s. Why yes, I did find out about Ruby's built-in
<a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/observer/rdoc%0A/Observable.html"><code>Observable</code></a> module right after writing this. Ignorance > NIH, right?</p>
]]></content>
  </entry>
  
</feed>
